# memtool Phase 2.6 æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆè¯„å®¡

> è¯„å®¡äººï¼šCodex  
> è¯„å®¡æ—¥æœŸï¼š2026-02-03  
> è®¾è®¡ç‰ˆæœ¬ï¼š0.3.1  
> è¯„å®¡ç»“è®ºï¼š**é€šè¿‡ï¼ˆæœ‰æ¡ä»¶ï¼‰**

---

## ğŸ“Š æ€»ä½“è¯„ä»·

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æŠ€æœ¯å¯è¡Œæ€§ | â­â­â­â­â­ | è®¾è®¡æ–¹æ¡ˆæŠ€æœ¯ä¸Šå®Œå…¨å¯è¡Œï¼Œæ— æ˜æ˜¾é˜»å¡ç‚¹ |
| è®¾è®¡åˆç†æ€§ | â­â­â­â­ | æ•´ä½“è®¾è®¡åˆç†ï¼Œéƒ¨åˆ†ç»†èŠ‚éœ€ä¼˜åŒ– |
| ä»£ç è´¨é‡ | â­â­â­â­ | ä»£ç ç»“æ„æ¸…æ™°ï¼Œä½†éœ€è¡¥å……é”™è¯¯å¤„ç† |
| é£é™©æ§åˆ¶ | â­â­â­â­ | ä¸»è¦é£é™©å·²è¯†åˆ«ï¼Œç¼“è§£æªæ–½åŸºæœ¬åˆ°ä½ |
| ä¼˜å…ˆçº§åˆ’åˆ† | â­â­â­â­â­ | P0-P3 åˆ’åˆ†åˆç†ï¼Œç¬¦åˆå®é™…éœ€æ±‚ |

**ç»¼åˆè¯„åˆ†ï¼š4.4/5.0**

---

## âœ… ä¼˜ç‚¹

### 1. ä¼˜å…ˆçº§åˆ’åˆ†ç§‘å­¦
- **P0 ä¿®å¤ Bug** â†’ **P1 æ ¸å¿ƒåŠŸèƒ½** â†’ **P2 æ€§èƒ½ä¼˜åŒ–** â†’ **P3 è¾…åŠ©åŠŸèƒ½**
- ç¬¦åˆ"å…ˆä¿®å¤ã€å†å®Œå–„ã€åå¢å¼º"çš„å·¥ç¨‹åŸåˆ™
- P0 çš„ vector_coverage ä¿®å¤ç¡®å®åº”è¯¥æœ€ä¼˜å…ˆå¤„ç†

### 2. ç‰ˆæœ¬å†å²è®¾è®¡æ‰å®
- ä½¿ç”¨ç‹¬ç«‹çš„ `memory_history` è¡¨ï¼Œé¿å…æ±¡æŸ“ä¸»è¡¨
- å¤–é”®çº¦æŸ `ON DELETE CASCADE` ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- ç´¢å¼•è®¾è®¡åˆç†ï¼ˆ`item_id` + `item_id, version` å¤åˆç´¢å¼•ï¼‰
- äº‹åŠ¡å†…ä¿å­˜å†å²ï¼Œä¿è¯åŸå­æ€§

### 3. é‡‡æ ·ç­–ç•¥åŠ¡å®
- é¿å… O(n) å…¨è¡¨æ‰«æï¼Œä½¿ç”¨ `ORDER BY RANDOM() LIMIT N` é‡‡æ ·
- 200 æ¡æ ·æœ¬é‡åœ¨ç»Ÿè®¡å­¦ä¸Šè¶³å¤Ÿï¼ˆè¯¯å·® â‰ˆ Â±7% @ 95% ç½®ä¿¡åº¦ï¼‰
- è¿”å›ä¼°ç®—å€¼è€Œéç²¾ç¡®å€¼ï¼Œç¬¦åˆæ€§èƒ½ä¸å‡†ç¡®æ€§çš„æƒè¡¡

### 4. åˆå¹¶å»ºè®®ä¿å®ˆå®‰å…¨
- ä»…å»ºè®®ä¸è‡ªåŠ¨æ‰§è¡Œï¼Œé¿å…è¯¯åˆ æ•°æ®
- é«˜é˜ˆå€¼ï¼ˆ0.85ï¼‰é™ä½è¯¯æŠ¥ç‡
- æä¾› `action_hint` æŒ‡å¯¼ç”¨æˆ·æ“ä½œ

### 5. æ–‡æ¡£å®Œæ•´
- è®¾è®¡æ–¹æ¡ˆã€éªŒæ”¶æ ‡å‡†ã€å®æ–½æ­¥éª¤ã€é£é™©ç¼“è§£ä¸€åº”ä¿±å…¨
- ä»£ç ç¤ºä¾‹è¯¦ç»†ï¼Œå¯ç›´æ¥å‚è€ƒå®ç°

---

## âš ï¸ é—®é¢˜ä¸é£é™©

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

#### 1. äº‹åŠ¡ç®¡ç†ä¸æ˜ç¡®
**é—®é¢˜**ï¼š
```python
def put(self, *, item_id, type, key, content, ...):
    conn = self._get_conn()
    # ...
    if row:
        _save_history(conn, item_id, row, "update")
        # ... æ‰§è¡Œæ›´æ–° ...
```

**é£é™©**ï¼š
- ä»£ç ç‰‡æ®µä¸­æœªæ˜¾å¼å¼€å¯äº‹åŠ¡
- å¦‚æœ `_save_history` æˆåŠŸä½†åç»­æ›´æ–°å¤±è´¥ï¼Œä¼šå¯¼è‡´å†å²è®°å½•ä¸ä¸€è‡´
- SQLite é»˜è®¤è‡ªåŠ¨æäº¤ï¼Œå¯èƒ½æ— æ³•ä¿è¯åŸå­æ€§

**å»ºè®®**ï¼š
```python
def put(self, *, item_id, type, key, content, ...):
    conn = self._get_conn()
    try:
        conn.execute("BEGIN IMMEDIATE")  # æ˜¾å¼å¼€å¯äº‹åŠ¡
        
        if row:
            _save_history(conn, item_id, row, "update")
            # ... æ‰§è¡Œæ›´æ–° ...
        
        conn.commit()
    except Exception as e:
        conn.rollback()
        raise
```

#### 2. å†å²è¡¨æ— æ¸…ç†æœºåˆ¶
**é—®é¢˜**ï¼š
- è®¾è®¡ä¸­æåˆ°"å†å²è¡¨å¢é•¿è¿‡å¿«"é£é™©ï¼Œä½†æœªæä¾›å…·ä½“ç¼“è§£ä»£ç 
- é•¿æœŸè¿è¡Œåï¼Œå†å²è¡¨å¯èƒ½å ç”¨å¤§é‡ç©ºé—´

**å»ºè®®**ï¼š
- åœ¨ `_save_history` ä¸­æ·»åŠ è‡ªåŠ¨æ¸…ç†é€»è¾‘ï¼š
```python
def _save_history(conn, item_id, old_row, change_type="update", max_versions=10):
    """ä¿å­˜å†å²å¹¶è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬"""
    # ä¿å­˜æ–°å†å²
    conn.execute("""INSERT INTO memory_history ...""")
    
    # æ¸…ç†è¶…è¿‡ max_versions çš„æ—§ç‰ˆæœ¬
    conn.execute("""
        DELETE FROM memory_history
        WHERE item_id = ? AND version NOT IN (
            SELECT version FROM memory_history
            WHERE item_id = ?
            ORDER BY version DESC
            LIMIT ?
        )
    """, (item_id, item_id, max_versions))
```

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 3. åˆå¹¶å»ºè®®æ€§èƒ½éšæ‚£
**é—®é¢˜**ï¼š
```python
for row in rows:  # æœ€å¤š 500 æ¡
    similar = store.find_similar_items(...)  # æ¯æ¬¡éƒ½è°ƒç”¨å‘é‡æœç´¢
```

**é£é™©**ï¼š
- æœ€åæƒ…å†µä¸‹è°ƒç”¨ 500 æ¬¡å‘é‡æœç´¢
- å¦‚æœå‘é‡åº“è¾ƒå¤§ï¼ˆ>10k æ¡ï¼‰ï¼Œå¯èƒ½è€—æ—¶æ•°ç§’ç”šè‡³æ•°åç§’

**å»ºè®®**ï¼š
- æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼š
```python
import time
start = time.time()
for row in rows:
    if time.time() - start > 5.0:  # 5 ç§’è¶…æ—¶
        break
    # ...
```
- æˆ–è€…é™ä½æ‰«æä¸Šé™ï¼ˆ500 â†’ 200ï¼‰

#### 4. é‡‡æ ·ç»Ÿè®¡çš„éšæœºæ€§é—®é¢˜
**é—®é¢˜**ï¼š
- `ORDER BY RANDOM()` åœ¨ SQLite ä¸­æ€§èƒ½è¾ƒå·®ï¼ˆéœ€è¦å…¨è¡¨æ‰«æç”Ÿæˆéšæœºæ•°ï¼‰
- æ¯æ¬¡è°ƒç”¨ç»“æœä¸åŒï¼Œå¯èƒ½å¯¼è‡´ç»Ÿè®¡æ•°æ®è·³å˜

**å»ºè®®**ï¼š
- ä½¿ç”¨ç¡®å®šæ€§é‡‡æ ·ï¼ˆå¦‚æ¯éš” N æ¡å–ä¸€æ¡ï¼‰ï¼š
```python
# æ–¹æ¡ˆ 1: ä½¿ç”¨ ROWID å–æ¨¡
SELECT * FROM memory_items WHERE ROWID % ? = 0 LIMIT ?

# æ–¹æ¡ˆ 2: ç¼“å­˜é‡‡æ ·ç»“æœï¼ˆ5 åˆ†é’Ÿå†…å¤ç”¨ï¼‰
```

#### 5. é”™è¯¯å¤„ç†ä¸å®Œæ•´
**é—®é¢˜**ï¼š
- `_compute_decay_stats_sampled` ä¸­æœªå¤„ç† `updated_at` è§£æå¤±è´¥çš„æƒ…å†µ
- `suggest_merges` ä¸­æœªå¤„ç† `find_similar_items` æŠ›å‡ºå¼‚å¸¸çš„æƒ…å†µ

**å»ºè®®**ï¼š
```python
try:
    d_score = decay_score(updated_at, item_type, now=now)
except (ValueError, TypeError) as e:
    logger.warning(f"Failed to compute decay for {row['id']}: {e}")
    continue  # è·³è¿‡è¯¥æ¡è®°å½•
```

---

### ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

#### 6. ç‰ˆæœ¬å·å¯èƒ½å†²çª
**é—®é¢˜**ï¼š
- å½“å‰è®¾è®¡ä¸­ï¼Œ`version` å­—æ®µåœ¨ `put()` æ—¶é€’å¢
- å¦‚æœå¹¶å‘æ›´æ–°åŒä¸€è®°å¿†ï¼Œå¯èƒ½å‡ºç°ç‰ˆæœ¬å·å†²çª

**å»ºè®®**ï¼š
- ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºç‰ˆæœ¬å·ï¼š
```python
version = int(time.time() * 1000)  # æ¯«ç§’çº§æ—¶é—´æˆ³
```
- æˆ–è€…åœ¨å†å²è¡¨ä¸­ä½¿ç”¨è‡ªå¢ IDï¼Œä¸ä¾èµ– version å­—æ®µ

#### 7. åˆå¹¶å»ºè®®çš„å†…å®¹é¢„è§ˆæˆªæ–­
**é—®é¢˜**ï¼š
```python
"content_preview": row["content"][:100] + "..."
```
- ç¡¬ç¼–ç  100 å­—ç¬¦å¯èƒ½æˆªæ–­ä¸­æ–‡å­—ç¬¦ï¼ˆUTF-8 ç¼–ç é—®é¢˜ï¼‰

**å»ºè®®**ï¼š
```python
def safe_preview(text: str, max_len: int = 100) -> str:
    """å®‰å…¨æˆªæ–­æ–‡æœ¬ï¼Œé¿å…æˆªæ–­å¤šå­—èŠ‚å­—ç¬¦"""
    if len(text) <= max_len:
        return text
    return text[:max_len].rsplit(' ', 1)[0] + "..."
```

#### 8. MCP å·¥å…·å‚æ•°éªŒè¯
**é—®é¢˜**ï¼š
- `memory_history` ä¸­ `limit` å‚æ•°æœªéªŒè¯èŒƒå›´
- ç”¨æˆ·å¯èƒ½ä¼ å…¥è´Ÿæ•°æˆ–è¶…å¤§å€¼

**å»ºè®®**ï¼š
```python
if limit < 1 or limit > 100:
    return _param_error("limit must be between 1 and 100")
```

---

## ğŸ’¡ æ”¹è¿›å»ºè®®

### 1. å¢å¼ºæµ‹è¯•è¦†ç›–
**å½“å‰çŠ¶æ€**ï¼šè®¾è®¡æ–‡æ¡£ä¸­ä»…æœ‰éªŒæ”¶æ ‡å‡†ï¼Œæ— å•å…ƒæµ‹è¯•è®¡åˆ’

**å»ºè®®**ï¼š
```python
# tests/test_history.py
def test_history_saved_on_update():
    """æµ‹è¯•æ›´æ–°æ—¶æ˜¯å¦æ­£ç¡®ä¿å­˜å†å²"""
    store.put(type="project", key="test", content="v1")
    item_id = store.recall(type="project", key="test")["id"]
    
    store.put(item_id=item_id, content="v2")
    
    history = get_history(store, item_id)
    assert len(history["history"]) == 1
    assert history["history"][0]["content"] == "v1"

def test_history_cleanup():
    """æµ‹è¯•å†å²ç‰ˆæœ¬è‡ªåŠ¨æ¸…ç†"""
    # åˆ›å»º 15 ä¸ªç‰ˆæœ¬
    for i in range(15):
        store.put(type="project", key="test", content=f"v{i}")
    
    # åº”è¯¥åªä¿ç•™æœ€è¿‘ 10 ä¸ª
    history = get_history(store, item_id)
    assert len(history["history"]) <= 10
```

### 2. æ·»åŠ é…ç½®é€‰é¡¹
**å»ºè®®**ï¼šå°†ç¡¬ç¼–ç çš„å¸¸é‡æ”¹ä¸ºå¯é…ç½®ï¼š
```python
# memtool/config.py
class MemtoolConfig:
    HISTORY_MAX_VERSIONS = 10  # æ¯ä¸ªè®°å¿†ä¿ç•™çš„æœ€å¤§å†å²ç‰ˆæœ¬æ•°
    DECAY_SAMPLE_SIZE = 200    # è¡°å‡ç»Ÿè®¡é‡‡æ ·æ•°é‡
    MERGE_SCAN_LIMIT = 500     # åˆå¹¶å»ºè®®æ‰«æä¸Šé™
    MERGE_THRESHOLD = 0.85     # é»˜è®¤ç›¸ä¼¼åº¦é˜ˆå€¼
```

### 3. æ€§èƒ½ç›‘æ§åŸ‹ç‚¹
**å»ºè®®**ï¼šåœ¨å…³é”®è·¯å¾„æ·»åŠ æ€§èƒ½æ—¥å¿—ï¼š
```python
import time

def suggest_merges(store, ...):
    start = time.time()
    # ... æ‰§è¡Œé€»è¾‘ ...
    elapsed = time.time() - start
    logger.info(f"suggest_merges completed in {elapsed:.2f}s, found {len(suggestions)} suggestions")
```

### 4. ç‰ˆæœ¬å†å²å¯è§†åŒ–
**å»ºè®®**ï¼šåœ¨ Phase 2.7 ä¸­è€ƒè™‘æ·»åŠ ï¼š
```python
@mcp.tool()
def memory_history_diff(item_id: str, version_a: int, version_b: int):
    """å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„å·®å¼‚ï¼ˆç±»ä¼¼ git diffï¼‰"""
    # è¿”å› unified diff æ ¼å¼
```

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§è¯„ä¼°

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | å·¥ä½œé‡ä¼°ç®— | è¯„å®¡æ„è§ |
|--------|------|-----------|---------|
| P0 | vector_coverage ä¿®å¤ | 0.5 å¤© | âœ… åˆç†ï¼Œå¿…é¡»ä¼˜å…ˆ |
| P1 | ç‰ˆæœ¬å†å² | 1 å¤© | âœ… åˆç†ï¼Œæ ¸å¿ƒåŠŸèƒ½ |
| P2 | è¡°å‡ç»Ÿè®¡ | 0.5 å¤© | âœ… åˆç†ï¼Œæ€§èƒ½ä¼˜åŒ– |
| P3 | åˆå¹¶å»ºè®® | 1 å¤© | âš ï¸ å»ºè®®é™ä¸º Phase 2.7 |

**è°ƒæ•´å»ºè®®**ï¼š
- **P3 åˆå¹¶å»ºè®®**åŠŸèƒ½ä»·å€¼è¾ƒä½ï¼Œä¸”æœ‰æ€§èƒ½éšæ‚£ï¼Œå»ºè®®æ¨è¿Ÿåˆ° Phase 2.7
- å°†èŠ‚çœçš„æ—¶é—´ç”¨äºï¼š
  1. è¡¥å……å•å…ƒæµ‹è¯•ï¼ˆ0.5 å¤©ï¼‰
  2. å®Œå–„é”™è¯¯å¤„ç†å’Œäº‹åŠ¡ç®¡ç†ï¼ˆ0.5 å¤©ï¼‰

**è°ƒæ•´åå·¥ä½œé‡**ï¼š2-3 å¤© â†’ 2.5 å¤©ï¼ˆæ›´ç¨³å¥ï¼‰

---

## ğŸ“‹ éªŒæ”¶æ ‡å‡†è¡¥å……

é™¤äº†è®¾è®¡æ–‡æ¡£ä¸­çš„éªŒæ”¶æ ‡å‡†ï¼Œå»ºè®®å¢åŠ ï¼š

### æ€§èƒ½éªŒæ”¶
```bash
# 1. å†å²è®°å½•å†™å…¥æ€§èƒ½ï¼ˆåº” <10msï¼‰
time mcporter call memtool.memory_store type:project key:perf_test content:"test"

# 2. å†å²æŸ¥è¯¢æ€§èƒ½ï¼ˆåº” <50msï¼‰
time mcporter call memtool.memory_history item_id:"xxx"

# 3. è¡°å‡ç»Ÿè®¡æ€§èƒ½ï¼ˆåº” <500msï¼Œå³ä½¿æœ‰ 10k æ¡è®°å¿†ï¼‰
time mcporter call memtool.memory_stats
```

### è¾¹ç•Œæƒ…å†µæµ‹è¯•
```bash
# 1. ç©ºåº“ç»Ÿè®¡
mcporter call memtool.memory_stats  # åº”è¿”å›åˆç†çš„é›¶å€¼

# 2. ä¸å­˜åœ¨çš„è®°å¿†å†å²
mcporter call memtool.memory_history item_id:"nonexistent"  # åº”è¿”å› NOT_FOUND

# 3. è¶…å¤§ limit
mcporter call memtool.memory_history item_id:"xxx" limit:99999  # åº”é™åˆ¶åœ¨åˆç†èŒƒå›´
```

---

## ğŸš¦ è¯„å®¡ç»“è®º

### âœ… é€šè¿‡æ¡ä»¶
1. **å¿…é¡»ä¿®å¤**ï¼šäº‹åŠ¡ç®¡ç†é—®é¢˜ï¼ˆä¸¥é‡é—®é¢˜ #1ï¼‰
2. **å¿…é¡»ä¿®å¤**ï¼šå†å²è¡¨æ¸…ç†æœºåˆ¶ï¼ˆä¸¥é‡é—®é¢˜ #2ï¼‰
3. **å»ºè®®ä¿®å¤**ï¼šåˆå¹¶å»ºè®®æ€§èƒ½ä¼˜åŒ–ï¼ˆä¸­ç­‰é—®é¢˜ #3ï¼‰
4. **å»ºè®®è¡¥å……**ï¼šå•å…ƒæµ‹è¯•ç”¨ä¾‹

### ğŸ“ æœ€ç»ˆå»ºè®®
- **Day 1**ï¼šP0 + P1ï¼ˆå«äº‹åŠ¡ç®¡ç†ä¿®å¤ï¼‰
- **Day 2**ï¼šP2 + å•å…ƒæµ‹è¯• + é”™è¯¯å¤„ç†å®Œå–„
- **Day 3**ï¼šé›†æˆæµ‹è¯• + æ–‡æ¡£æ›´æ–° + å‘å¸ƒ
- **Phase 2.7**ï¼šP3 åˆå¹¶å»ºè®®ï¼ˆä¼˜åŒ–åå†ä¸Šçº¿ï¼‰

### ğŸ–ï¸ æ€»ä½“è¯„ä»·
è¿™æ˜¯ä¸€ä»½**é«˜è´¨é‡çš„æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ**ï¼Œä½“ç°äº†ï¼š
- æ¸…æ™°çš„é—®é¢˜åˆ†æå’Œè§£å†³æ€è·¯
- åˆç†çš„ä¼˜å…ˆçº§åˆ’åˆ†
- å®Œæ•´çš„æ–‡æ¡£å’ŒéªŒæ”¶æ ‡å‡†
- å¯¹é£é™©çš„é¢„åˆ¤å’Œç¼“è§£

ä¿®å¤ä¸Šè¿°ä¸¥é‡é—®é¢˜åï¼Œå¯ä»¥æ”¾å¿ƒå®æ–½ã€‚

---

**è¯„å®¡äººç­¾å**ï¼šCodex  
**è¯„å®¡æ—¶é—´**ï¼š2026-02-03 11:18 GMT+8  
**ä¸‹æ¬¡è¯„å®¡**ï¼šPhase 2.7 è®¾è®¡æ–¹æ¡ˆ
